{"ast":null,"code":"var util = require(\"util\"),\n    stream = require(\"stream\"),\n    constants = require(\"./constants\"); // TODO: clear up specs on returning false from a write and emitting a drain event.\n// Does this mean if I return false from a write, I should ignore any write requests between that false return and the drain event?\n\n\nvar WritableStreamBuffer = module.exports = function (opts) {\n  var that = this;\n  stream.Stream.call(this);\n  opts = opts || {};\n  var initialSize = opts.initialSize || constants.DEFAULT_INITIAL_SIZE;\n  var incrementAmount = opts.incrementAmount || constants.DEFAULT_INCREMENT_AMOUNT;\n  var buffer = new Buffer(initialSize);\n  var size = 0;\n  this.writable = true;\n  this.readable = false;\n\n  this.size = function () {\n    return size;\n  };\n\n  this.maxSize = function () {\n    return buffer.length;\n  };\n\n  this.getContents = function (length) {\n    if (!size) return false;\n    var data = new Buffer(Math.min(length || size, size));\n    buffer.copy(data, 0, 0, data.length);\n    if (data.length < size) buffer.copy(buffer, 0, data.length);\n    size -= data.length;\n    return data;\n  };\n\n  this.getContentsAsString = function (encoding, length) {\n    if (!size) return false;\n    var data = buffer.toString(encoding || \"utf8\", 0, Math.min(length || size, size));\n    var dataLength = Buffer.byteLength(data);\n    if (dataLength < size) buffer.copy(buffer, 0, dataLength);\n    size -= dataLength;\n    return data;\n  };\n\n  var increaseBufferIfNecessary = function increaseBufferIfNecessary(incomingDataSize) {\n    if (buffer.length - size < incomingDataSize) {\n      var factor = Math.ceil((incomingDataSize - (buffer.length - size)) / incrementAmount);\n      var newBuffer = new Buffer(buffer.length + incrementAmount * factor);\n      buffer.copy(newBuffer, 0, 0, size);\n      buffer = newBuffer;\n    }\n  };\n\n  this.write = function (data, encoding, callback) {\n    if (!that.writable) return;\n\n    if (Buffer.isBuffer(data)) {\n      increaseBufferIfNecessary(data.length);\n      data.copy(buffer, size, 0);\n      size += data.length;\n    } else {\n      data = data + \"\";\n      increaseBufferIfNecessary(Buffer.byteLength(data));\n      buffer.write(data, size, encoding || \"utf8\");\n      size += Buffer.byteLength(data);\n    }\n\n    if (typeof callback === \"function\") {\n      callback();\n    }\n  };\n\n  this.end = function () {\n    var args = Array.prototype.slice.apply(arguments);\n    if (args.length) that.write.apply(that, args);\n    that.emit('finish');\n    that.destroy();\n  };\n\n  this.destroySoon = this.destroy = function () {\n    that.writable = false;\n    that.emit(\"close\");\n  };\n};\n\nutil.inherits(WritableStreamBuffer, stream.Stream);","map":null,"metadata":{},"sourceType":"script"}